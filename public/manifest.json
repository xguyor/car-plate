import { NextResponse } from 'next/server'
import { createRouteHandlerClient } from '@supabase/auth-helpers-nextjs'
import { cookies } from 'next/headers'
import { Resend } from 'resend'
import webpush from 'web-push'

const resend = new Resend(process.env.RESEND_API_KEY)

// Configure VAPID for Web Push
if (process.env.VAPID_PRIVATE_KEY) {
  webpush.setVapidDetails(
    'mailto:alerts@forsightrobotics.com',
    process.env.NEXT_PUBLIC_VAPID_PUBLIC_KEY!,
    process.env.VAPID_PRIVATE_KEY
  )
}

export async function POST(request: Request) {
  const supabase = createRouteHandlerClient({ cookies })
  const { data: { user } } = await supabase.auth.getUser()
  
  if (!user) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
  }

  try {
    const { plate, manualCorrection, confidence } = await request.json()

    // Validate plate format
    const isValid = /^\d{2}-\d{3}-\d{2}$/.test(plate) || /^\d{3}-\d{2}-\d{3}$/.test(plate)
    if (!isValid) {
      return NextResponse.json({ error: 'Invalid plate format' }, { status: 400 })
    }

    // Rate limiting: max 3 alerts per minute
    const oneMinuteAgo = new Date(Date.now() - 60000).toISOString()
    const { data: recentAlerts } = await supabase
      .from('alerts')
      .select('id')
      .eq('sender_id', user.id)
      .gte('created_at', oneMinuteAgo)
    
    if (recentAlerts && recentAlerts.length >= 3) {
      return NextResponse.json({ 
        error: 'Rate limit: Max 3 alerts per minute' 
      }, { status: 429 })
    }

    // Find car owner by plate
    const { data: owner, error: ownerError } = await supabase
      .from('users')
      .select('*')
      .eq('car_plate', plate)
      .single()
    
    if (ownerError || !owner) {
      return NextResponse.json({ 
        error: 'Plate not registered in system' 
      }, { status: 404 })
    }

    // Don't allow alerting yourself
    if (owner.id === user.id) {
      return NextResponse.json({ 
        error: 'Cannot alert your own car' 
      }, { status: 400 })
    }

    // Log the alert
    const { error: insertError } = await supabase
      .from('alerts')
      .insert({
        sender_id: user.id,
        receiver_id: owner.id,
        detected_plate: plate,
        manual_correction: manualCorrection,
        ocr_confidence: confidence
      })

    if (insertError) throw insertError

    // Send email notification
    try {
      await resend.emails.send({
        from: 'CarBlock Alert <onboarding@resend.dev>', // Use your verified domain
        to: owner.email,
        subject: 'ðŸš— URGENT: Your car is blocking someone',
        html: `
          <div style="font-family: sans-serif; max-width: 600px; margin: 0 auto;">
            <h2 style="color: #2563eb;">ðŸš— Your Car is Blocking</h2>
            <p>Hi,</p>
            <p>Your car with plate number <strong>${plate}</strong> is blocking someone at the parking lot.</p>
            <p>Please move it as soon as possible.</p>
            <p style="color: #666; font-size: 12px; margin-top: 20px;">
              Sent via CarBlock Alert System
            </p>
          </div>
        `
      })
    } catch (emailError) {
      console.error('Email failed:', emailError)
      // Don't fail the request if email fails
    }

    // Send push notification
    if (owner.push_subscription) {
      try {
        await webpush.sendNotification(
          owner.push_subscription,
          JSON.stringify({
            title: 'ðŸš— Move Your Car',
            body: `Your car (${plate}) is blocking someone`,
            icon: '/icon-192.png',
            badge: '/icon-192.png',
            data: { url: '/history' }
          })
        )
      } catch (pushError) {
        console.error('Push notification failed:', pushError)
        // Don't fail if push fails
      }
    }

    return NextResponse.json({ 
      success: true,
      owner: owner.email 
    })

  } catch (error: any) {
    console.error('Alert error:', error)
    return NextResponse.json({ 
      error: error.message || 'Failed to send alert' 
    }, { status: 500 })
  }
}